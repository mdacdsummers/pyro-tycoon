<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyro Tycoon</title>
    <style>
        :root {
            --primary-color: #ff6600; --dark-bg: #1a1a1a; --medium-bg: #2b2b2b; --light-bg: #3c3c3c; --text-color: #f0f0f0;
        }
        body { font-family: system-ui, sans-serif; background-color: var(--dark-bg); color: var(--text-color); margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        h1, h2 { color: var(--primary-color); border-bottom: 2px solid var(--medium-bg); padding-bottom: 10px; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; font-weight: bold; }
        button:hover:not(:disabled) { background-color: #cc5200; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--medium-bg); padding: 12px; text-align: left; }
        th { background-color: var(--light-bg); }
        .dashboard { display: flex; flex-wrap: wrap; justify-content: space-around; background-color: var(--medium-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; gap: 15px; }
        .stat { text-align: center; }
        .stat-label { font-size: 0.9em; color: #aaa; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: var(--primary-color); }
        .main-content { display: flex; gap: 20px; align-items: flex-start; margin-top: 30px;}
        .operations-section { flex: 3; }
        .cart-section { flex: 2; position: sticky; top: 20px; }
        #sales-sim-btn { background-color: #28a745; grid-column: 1 / -1; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>ðŸ”¥ Pyro Tycoon ðŸ”¥</h1>
    <div id="auth-container"> <button id="authorize_button">Authorize</button> <button id="signout_button" class="hidden">Sign Out</button> </div>

    <div id="game-content" class="hidden">
        <div class="dashboard">
            <div class="stat"> <div class="stat-label">Company Name</div> <div class="stat-value" id="company-name">--</div> </div>
            <div class="stat"> <div class="stat-label">Cash on Hand</div> <div class="stat-value" id="company-cash">--</div> </div>
            <div class="stat"> <div class="stat-label">Business Tier</div> <div class="stat-value" id="company-tier">--</div> </div>
            <div class="stat"> <div class="stat-label">Warehouse</div> <div class="stat-value" id="company-warehouse">--</div> </div>
            <div class="stat"> <div class="stat-label">Current Date</div> <div class="stat-value" id="game-date">--</div> </div>
            <button id="sales-sim-btn">Simulate Day's Sales & Advance Day</button>
        </div>

        <div class="main-content">
            <div class="operations-section">
                <h2>Operations</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Wholesale Cost</th>
                            <th>Cases (Warehouse)</th>
                            <th>Pieces (Store)</th>
                            <th>Cases (In Transit)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="operations-display"></tbody>
                </table>
            </div>

            <div class="cart-section">
                <h2>Purchase Order</h2>
                <div id="cart-items-list"></div>
                <div id="cart-summary" class="hidden" style="margin-top: 20px;">
                     <div class="summary-row"><span>Subtotal:</span><span id="summary-subtotal">$0.00</span></div>
                     <div class="summary-row"><span>Discount:</span><span id="summary-discount">$0.00</span></div>
                     <div class="summary-row total"><span>Total:</span><span id="summary-total">$0.00</span></div>
                </div>
                <button id="checkout-button" style="width: 100%; margin-top: 20px;" disabled>Place Order</button>
            </div>
        </div>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script>
        // --- 1. CONFIGURATION ---
        const CLIENT_ID = '669296235016-hsad02vdji7hissovhrb9rhdtj58s34k.apps.googleusercontent.com'; // <--- IMPORTANT: PASTE YOUR CLIENT ID HERE
        const API_KEY = 'AIzaSyAJ05PWrO322D4Zj5tSGIDjnLAUQRe0NuI'; // Although not always needed for OAuth2, it's good practice
        const SPREADSHEET_ID = '1MciP2EEEC74434RKCnSIkzXS3XCtgd4EATD1ViLLPL0'; // <--- IMPORTANT: PASTE YOUR SPREADSHEET ID HERE
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';

        // --- STATE & DOM ---
        let tokenClient, gapiInited = false, gisInited = false;
        let companyData = {}, products = new Map(), cart = [], inventory = new Map(), inTransit = new Map();
        const authorizeButton = document.getElementById('authorize_button'), signoutButton = document.getElementById('signout_button');
        const gameContent = document.getElementById('game-content'), checkoutButton = document.getElementById('checkout-button');
        const cartList = document.getElementById('cart-items-list'), cartSummary = document.getElementById('cart-summary');
        const salesSimBtn = document.getElementById('sales-sim-btn');
        const operationsDisplay = document.getElementById('operations-display');

        // --- INITIALIZATION ---
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
        checkoutButton.onclick = processCheckout;
        salesSimBtn.onclick = simulateSales;
        
        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] }); gapiInited = true; maybeEnableButtons(); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; maybeEnableButtons(); }
        function maybeEnableButtons() { if (gapiInited && gisInited) authorizeButton.disabled = false; }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) throw (resp);
                authorizeButton.classList.add('hidden');
                signoutButton.classList.remove('hidden');
                gameContent.classList.remove('hidden');
                await loadGameData();
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                authorizeButton.classList.remove('hidden');
                signoutButton.classList.add('hidden');
                gameContent.classList.add('hidden');
            }
        }
        
        // --- DATA LOADING ---
        async function loadGameData() {
            try {
                await loadProductCatalog();
                await Promise.all([loadCompanyInfo(), loadInventoryData(), loadInTransitData()]);
                renderAll();
            } catch (err) { console.error("Fatal error loading game data:", err); alert("A critical error occurred. Please check the console (F12)."); }
        }

        async function loadProductCatalog() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Products!A2:J' });
            products.clear();
            (res.result.values || []).forEach(p => products.set(p[0], { sku: p[0], name: p[1], category: p[2], wholesaleCost: parseFloat(p[6]), retailPrice: parseFloat(p[7]), piecesPerCase: parseInt(p[8]) || 1, sqft: parseInt(p[9]) || 1 }));
        }

        async function loadCompanyInfo() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'My_Company!A2:E2' });
            const data = res.result.values[0];
            companyData = { name: data[0], cash: parseFloat(data[1]) || 0, tier: data[2], warehouseSize: parseInt(data[3]) || 0, date: data[4] };
        }

        async function loadInventoryData() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Inventory!A2:E' });
            inventory.clear();
            let rowNum = 2;
            (res.result.values || []).forEach(row => {
                inventory.set(row[0], { sku: row[0], name: row[1], casesInWarehouse: parseInt(row[2]) || 0, piecesInStore: parseInt(row[3]) || 0, piecesPerCase: parseInt(row[4]) || 0, rowNum: rowNum++ });
            });
        }

        async function loadInTransitData() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'In-Transit_Orders!B2:C' });
            inTransit.clear();
            (res.result.values || []).forEach(row => {
                const sku = row[0];
                const cases = parseInt(row[1]) || 0;
                inTransit.set(sku, (inTransit.get(sku) || 0) + cases);
            });
        }
        
        // --- UI RENDERING ---
        function renderAll() {
            updateDashboardUI();
            renderOperationsView();
            renderCart();
        }

        function updateDashboardUI() {
            document.getElementById('company-name').innerText = companyData.name;
            document.getElementById('company-cash').innerText = `$${companyData.cash.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
            document.getElementById('company-tier').innerText = companyData.tier;
            document.getElementById('game-date').innerText = companyData.date;
            let totalSqFtUsed = 0;
            for (const item of inventory.values()) {
                const productInfo = products.get(item.sku);
                if (productInfo) totalSqFtUsed += item.casesInWarehouse * productInfo.sqft;
            }
            document.getElementById('company-warehouse').innerText = `${totalSqFtUsed.toLocaleString()} / ${companyData.warehouseSize.toLocaleString()} SqFt`;
        }
        
        function renderOperationsView() {
            operationsDisplay.innerHTML = "";
            products.forEach(product => {
                const invItem = inventory.get(product.sku) || { casesInWarehouse: 0, piecesInStore: 0 };
                const transitCases = inTransit.get(product.sku) || 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>$${product.wholesaleCost.toFixed(2)}</td>
                    <td>${invItem.casesInWarehouse}</td>
                    <td>${invItem.piecesInStore}</td>
                    <td>${transitCases}</td>
                    <td>
                        <button class="buy-btn" data-sku="${product.sku}">Buy Case</button>
                        <button class="unbox-btn" data-sku="${product.sku}" ${invItem.casesInWarehouse > 0 ? '' : 'disabled'}>Unbox Case</button>
                    </td>
                `;
                operationsDisplay.appendChild(row);
            });
            document.querySelectorAll('.buy-btn').forEach(btn => btn.addEventListener('click', e => updateCartQuantity(e.target.dataset.sku, 1)));
            document.querySelectorAll('.unbox-btn').forEach(btn => btn.addEventListener('click', e => moveCaseToStore(e.target.dataset.sku)));
        }

        function renderCart() {
            cartList.innerHTML = "";
            if (cart.length === 0) {
                cartList.innerHTML = "<p>Your cart is empty.</p>";
                cartSummary.classList.add('hidden');
                checkoutButton.disabled = true;
                return;
            }
            cart.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `<div><strong>${item.name}</strong><br>$${(item.wholesaleCost * item.quantity).toFixed(2)}</div><div class="cart-item-controls"><button class="cart-btn-minus">-</button><span>${item.quantity}</span><button class="cart-btn-plus">+</button></div><button class="cart-btn-remove">&times;</button>`;
                itemDiv.querySelector('.cart-btn-minus').addEventListener('click', () => updateCartQuantity(item.sku, -1));
                itemDiv.querySelector('.cart-btn-plus').addEventListener('click', () => updateCartQuantity(item.sku, 1));
                itemDiv.querySelector('.cart-btn-remove').addEventListener('click', () => removeFromCart(item.sku));
                cartList.appendChild(itemDiv);
            });
            const { subtotal, discount, total } = calculateTotals();
            document.getElementById('summary-subtotal').innerText = `$${subtotal.toFixed(2)}`;
            document.getElementById('summary-discount').innerText = `-$${discount.toFixed(2)}`;
            document.getElementById('summary-total').innerText = `$${total.toFixed(2)}`;
            cartSummary.classList.remove('hidden');
            let totalSqFtUsed = 0;
            inventory.forEach(item => totalSqFtUsed += (products.get(item.sku)?.sqft || 0) * item.casesInWarehouse);
            const sqFtOfOrder = cart.reduce((sum, item) => sum + products.get(item.sku).sqft * item.quantity, 0);
            const availableSqFt = companyData.warehouseSize - totalSqFtUsed;
            if (total > companyData.cash) { checkoutButton.disabled = true; checkoutButton.innerText = 'Insufficient Funds'; }
            else if (sqFtOfOrder > availableSqFt) { checkoutButton.disabled = true; checkoutButton.innerText = 'Not Enough Space'; }
            else { checkoutButton.disabled = false; checkoutButton.innerText = 'Place Order'; }
        }

        // --- GAME LOGIC ---
        function updateCartQuantity(sku, change) {
            let itemInCart = cart.find(item => item.sku === sku);
            if (itemInCart) {
                itemInCart.quantity += change;
                if (itemInCart.quantity <= 0) removeFromCart(sku);
            } else if (change > 0) {
                const product = products.get(sku);
                if (product) cart.push({ ...product, quantity: 1 });
            }
            renderCart();
        }
        function removeFromCart(sku) {
            cart = cart.filter(item => item.sku !== sku);
            renderCart();
        }
        function calculateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + item.wholesaleCost * item.quantity, 0);
            let discountRate = 0;
            if (subtotal >= 100000) discountRate = 0.50; else if (subtotal >= 50000) discountRate = 0.45; else if (subtotal >= 25000) discountRate = 0.35;
            else if (subtotal >= 10000) discountRate = 0.25; else if (subtotal >= 5000) discountRate = 0.15;
            const discount = subtotal * discountRate;
            return { subtotal, discount, total: subtotal - discount };
        }
        async function moveCaseToStore(sku) {
            const item = inventory.get(sku);
            if (!item || item.casesInWarehouse <= 0) return;
            document.querySelector(`.unbox-btn[data-sku="${sku}"]`).disabled = true;
            item.casesInWarehouse--;
            item.piecesInStore += item.piecesPerCase;
            renderOperationsView();
            try {
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: `Inventory!C${item.rowNum}:D${item.rowNum}`, valueInputOption: "USER_ENTERED", resource: { values: [[item.casesInWarehouse, item.piecesInStore]] } });
            } catch (err) {
                console.error("Failed to update inventory:", err);
                item.casesInWarehouse++;
                item.piecesInStore -= item.piecesPerCase;
                renderOperationsView();
                alert("Error saving changes. Please refresh.");
            }
        }
        async function processCheckout() {
            checkoutButton.disabled = true;
            checkoutButton.innerText = 'Processing...';
            const { total } = calculateTotals();
            const newCash = companyData.cash - total;
            if (isNaN(newCash)) {
                alert("Fatal Error: Calculation resulted in an invalid number.");
                console.error("Checkout failed: newCash is NaN.", { cash: companyData.cash, total });
                checkoutButton.disabled = false;
                checkoutButton.innerText = 'Place Order';
                return;
            }
            try {
                const purchaseId = `PO-${Date.now()}`;
                const arrivalDate = new Date(companyData.date);
                arrivalDate.setDate(arrivalDate.getDate() + 7);
                const arrivalDateString = `${arrivalDate.getMonth() + 1}/${arrivalDate.getDate()}/${arrivalDate.getFullYear()}`;
                const purchaseLogData = cart.map(item => [`${purchaseId}-${item.sku}`, companyData.date, item.sku, item.quantity, item.wholesaleCost]);
                const inTransitData = cart.map(item => [purchaseId, item.sku, item.quantity, arrivalDateString]);
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'My_Company!B2', valueInputOption: 'USER_ENTERED', resource: { values: [[newCash]] } });
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'Purchase_Log!A1', valueInputOption: 'USER_ENTERED', resource: { values: purchaseLogData } });
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'In-Transit_Orders!A1', valueInputOption: 'USER_ENTERED', resource: { values: inTransitData } });
                cart = [];
                await loadGameData();
                alert(`Purchase successful! Your shipment will arrive on ${arrivalDateString}.`);
            } catch (err) {
                console.error("Checkout error:", err);
                alert("An error occurred during checkout.");
            } finally {
                checkoutButton.disabled = false;
                checkoutButton.innerText = 'Place Order';
                renderCart();
            }
        }
        async function checkBusinessTier() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Purchase_Log!D2:E' });
                const lifetimeTotal = (response.result.values || []).reduce((sum, row) => sum + ((parseInt(row[0]) || 0) * (parseFloat(row[1]) || 0)), 0);
                let newTier = 'Starter';
                if (lifetimeTotal >= 5000000) newTier = 'Diamond'; else if (lifetimeTotal >= 1500000) newTier = 'Platinum'; else if (lifetimeTotal >= 500000) newTier = 'Gold';
                else if (lifetimeTotal >= 100000) newTier = 'Silver'; else if (lifetimeTotal >= 25000) newTier = 'Bronze';
                if (newTier !== companyData.tier) {
                    await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'My_Company!C2', valueInputOption: 'USER_ENTERED', resource: { values: [[newTier]] } });
                    alert(`Congratulations! You've been promoted to the ${newTier} tier!`);
                    await loadCompanyInfo();
                    updateDashboardUI();
                }
            } catch (err) { console.error("Error checking business tier:", err); }
        }
        async function checkForArrivingShipments() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'In-Transit_Orders!A2:D' });
            const inTransitOrders = res.result.values || [];
            if (inTransitOrders.length === 0) return;
            const todaysDate = new Date(companyData.date);
            const arrivedShipments = [];
            const stillInTransit = [];
            inTransitOrders.forEach(order => {
                const arrivalDate = new Date(order[3]);
                if (arrivalDate <= todaysDate) {
                    arrivedShipments.push({ sku: order[1], cases: parseInt(order[2]) });
                } else {
                    stillInTransit.push(order);
                }
            });
            if (arrivedShipments.length > 0) {
                arrivedShipments.forEach(shipment => {
                    const item = inventory.get(shipment.sku);
                    if (item) {
                        item.casesInWarehouse += shipment.cases;
                    } else {
                        const product = products.get(shipment.sku);
                        inventory.set(shipment.sku, { sku: shipment.sku, name: product.name, casesInWarehouse: shipment.cases, piecesInStore: 0, piecesPerCase: product.piecesPerCase, rowNum: inventory.size + 2 });
                    }
                });
                await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: SPREADSHEET_ID, range: 'In-Transit_Orders!A2:D' });
                if (stillInTransit.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'In-Transit_Orders!A2', valueInputOption: 'USER_ENTERED', resource: { values: stillInTransit } });
                }
                const inventorySheetData = Array.from(inventory.values()).map(i => [i.sku, i.name, i.casesInWarehouse, i.piecesInStore, i.piecesPerCase]);
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'Inventory!A2', valueInputOption: 'USER_ENTERED', resource: { values: inventorySheetData } });
                alert(`A shipment has arrived with ${arrivedShipments.length} type(s) of fireworks!`);
            }
        }
        async function simulateSales() {
            salesSimBtn.disabled = true;
            salesSimBtn.textContent = 'Simulating...';
            try {
                await checkForArrivingShipments();
                let dailyRevenue = 0;
                const salesLogEntries = [];
                const inventoryUpdates = [];
                const currentDate = new Date(companyData.date);
                const currentMonth = currentDate.getMonth();
                let demandMultiplier = 0.3;
                if (currentMonth === 5 || currentMonth === 6) { demandMultiplier = 1.0; }
                else if (currentMonth === 4 || currentMonth === 7 || currentMonth === 11) { demandMultiplier = 0.6; }

                for (const item of inventory.values()) {
                    if (item.piecesInStore <= 0) continue;
                    if (Math.random() < (0.5 * demandMultiplier)) {
                        const productInfo = products.get(item.sku);
                        const piecesSold = Math.min(item.piecesInStore, Math.floor(Math.random() * 5) + 1);
                        if (piecesSold > 0) {
                            dailyRevenue += piecesSold * productInfo.retailPrice;
                            item.piecesInStore -= piecesSold;
                            salesLogEntries.push([ `SALE-${Date.now()}-${item.sku}`, companyData.date, item.sku, piecesSold, productInfo.retailPrice ]);
                            inventoryUpdates.push({ range: `Inventory!D${item.rowNum}`, values: [[item.piecesInStore]] });
                        }
                    }
                }

                currentDate.setDate(currentDate.getDate() + 1);
                const nextDate = `${currentDate.getMonth() + 1}/${currentDate.getDate()}/${currentDate.getFullYear()}`;

                if (salesLogEntries.length > 0) {
                    const newCash = companyData.cash + dailyRevenue;
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: { valueInputOption: 'USER_ENTERED', data: [ ...inventoryUpdates, { range: 'My_Company!B2', values: [[newCash]] }, { range: 'My_Company!E2', values: [[nextDate]] } ] }
                    });
                    await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'Sales_Log!A1', valueInputOption: 'USER_ENTERED', resource: { values: salesLogEntries } });
                    alert(`Day Advanced! You made ${salesLogEntries.length} sales for a total of $${dailyRevenue.toFixed(2)}.`);
                } else {
                    await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'My_Company!E2', valueInputOption: 'USER_ENTERED', resource: { values: [[nextDate]] } });
                    alert("A quiet day with no sales. The date has advanced.");
                }
                await loadGameData();
            } catch (err) {
                console.error("Error during sales simulation:", err);
                alert("An error occurred while saving sales data. Please check the console and refresh.");
            } finally {
                salesSimBtn.disabled = false;
                salesSimBtn.textContent = "Simulate Day's Sales & Advance Day";
            }
        }
    </script>
</body>
</html>

