<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyro Tycoon</title>
    <style>
        :root {
            --primary-color: #ff6600; --dark-bg: #1a1a1a; --medium-bg: #2b2b2b; --light-bg: #3c3c3c; --text-color: #f0f0f0;
        }
        body { font-family: system-ui, sans-serif; background-color: var(--dark-bg); color: var(--text-color); margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        h1, h2 { color: var(--primary-color); border-bottom: 2px solid var(--medium-bg); padding-bottom: 10px; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; font-weight: bold; }
        button:hover:not(:disabled) { background-color: #cc5200; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--medium-bg); padding: 12px; text-align: left; }
        th { background-color: var(--light-bg); position: sticky; top: 0; }
        .dashboard { display: flex; flex-wrap: wrap; justify-content: space-around; background-color: var(--medium-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; gap: 15px; }
        .stat { text-align: center; }
        .stat-label { font-size: 0.9em; color: #aaa; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: var(--primary-color); }
        .main-content { display: flex; gap: 20px; align-items: flex-start; }
        .operations-section { flex: 3.5; max-height: 75vh; overflow-y: auto; }
        .cart-section { flex: 1.5; position: sticky; top: 20px; }
        #sales-sim-btn { background-color: #28a745; grid-column: 1 / -1; margin-top: 10px; }
        #cart-items-list { max-height: 60vh; overflow-y: auto; }
        #toggle-container { grid-column: 1 / -1; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
        
        /* NEW: Cart Item Style */
        .cart-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--light-bg);
        }
        .cart-item button { padding: 5px 10px; }

    </style>
</head>
<body>
    <h1>ðŸ”¥ Pyro Tycoon ðŸ”¥</h1>
    <div id="auth-container">
        <button id="authorize_button">Authorize</button>
        <button id="signout_button" class="hidden">Sign Out</button>
        <button id="fresh-start-btn" class="hidden" style="background-color:#dc3545;">Start Fresh Game</button>
    </div>

    <div id="game-content" class="hidden">
        <div class="dashboard">
            <div class="stat"> <div class="stat-label">Company Name</div> <div class="stat-value" id="company-name">--</div> </div>
            <div class="stat"> <div class="stat-label">Cash on Hand</div> <div class="stat-value" id="company-cash">--</div> </div>
            <div class="stat"> <div class="stat-label">Business Tier</div> <div class="stat-value" id="company-tier">--</div> </div>
            <div class="stat"> <div class="stat-label">Warehouse</div> <div class="stat-value" id="company-warehouse">--</div> </div>
            <div class="stat"> <div class="stat-label">In-Transit SqFt</div> <div class="stat-value" id="in-transit-sqft">--</div> </div>
            <div class="stat"> <div class="stat-label">Current Date</div> <div class="stat-value" id="game-date">--</div> </div>
            <div id="toggle-container">
                <input type="checkbox" id="seven-day-toggle" checked>
                <label for="seven-day-toggle">Open 7 Days/Week</label>
            </div>
            <button id="sales-sim-btn">Simulate Day/Week</button>
            <div id="event-banner" class="hidden" style="grid-column: 1 / -1; margin-top: 10px; padding: 10px; background-color: #0275d8; border-radius: 5px; font-weight: bold; text-align: center;"></div>
        </div>

        <div class="main-content">
            <div class="operations-section">
                <h2>Operations</h2>
                <button id="unbox-all-btn" style="margin-bottom: 10px;">Unbox All Low Stock (â‰¤1)</button>
                <div id="monthly-special-container">
                    <h3>Monthly Special!</h3>
                    <p id="special-offer-text">Loading this month's special...</p>
                    <button id="buy-special-btn" class="hidden">Accept Special Offer</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Wholesale Cost</th>
                            <th>Cases (Warehouse)</th>
                            <th>Pieces (Store)</th>
                            <th>Cases (In Transit)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="operations-display"></tbody>
                </table>
            </div>
            <div class="cart-section">
                <h2>Purchase Order</h2>
                <button id="add-all-btn" style="width: 100%; margin-bottom: 15px; background-color: #0275d8;">Add 1 of Each</button>
                <div id="cart-items-list"></div>
                <div id="cart-summary" class="hidden" style="margin-top: 20px;">
                    <div class="summary-row"><span>Subtotal:</span><span id="summary-subtotal">$0.00</span></div>
                    <div class="summary-row"><span>Discount:</span><span id="summary-discount">$0.00</span></div>
                    <div class="summary-row"><span>Order SqFt:</span><span id="summary-sqft">0</span></div>
                    <div class="summary-row total"><span>Total:</span><span id="summary-total">$0.00</span></div>
                </div>
                <button id="checkout-button" style="width: 100%; margin-top: 20px;" disabled>Place Order</button>
            </div>
        </div>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script>
        // --- 1. CONFIGURATION ---
        const CLIENT_ID = '669296235016-hsad02vdji7hissovhrb9rhdtj58s34k.apps.googleusercontent.com'; // <--- IMPORTANT: PASTE YOUR CLIENT ID HERE
        const API_KEY = 'AIzaSyAJ05PWrO322D4Zj5tSGIDjnLAUQRe0NuI'; // Although not always needed for OAuth2, it's good practice
        const SPREADSHEET_ID = '1MciP2EEEC74434RKCnSIkzXS3XCtgd4EATD1ViLLPL0'; // <--- IMPORTANT: PASTE YOUR SPREADSHEET ID HERE
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';

        // --- STATE & DOM ---
        let tokenClient, gapiInited = false, gisInited = false;
        let companyData = {}, products = new Map(), cart = [], inventory = new Map(), inTransit = new Map(), events = [];
        const authorizeButton = document.getElementById('authorize_button'), signoutButton = document.getElementById('signout_button');
        const gameContent = document.getElementById('game-content'), checkoutButton = document.getElementById('checkout-button');
        const cartList = document.getElementById('cart-items-list'), cartSummary = document.getElementById('cart-summary');
        const salesSimBtn = document.getElementById('sales-sim-btn'), operationsDisplay = document.getElementById('operations-display');
        const addAllBtn = document.getElementById('add-all-btn'), unboxAllBtn = document.getElementById('unbox-all-btn');
        const freshStartBtn = document.getElementById('fresh-start-btn'), sevenDayToggle = document.getElementById('seven-day-toggle');
        const specialOfferText = document.getElementById('special-offer-text'), buySpecialBtn = document.getElementById('buy-special-btn');

        // --- INITIALIZATION & AUTH ---
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
        checkoutButton.onclick = processCheckout;
        salesSimBtn.onclick = simulateSales;
        addAllBtn.onclick = addAllToCart;
        unboxAllBtn.onclick = unboxAllLowStock;
        freshStartBtn.onclick = startFreshGame;
        sevenDayToggle.onchange = updateSimulateButton;
        buySpecialBtn.onclick = purchaseMonthlySpecial;
        
        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
            maybeAttemptSilentSignIn();
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse.error) { authorizeButton.classList.remove('hidden'); return; }
                    gapi.client.setToken(tokenResponse);
                    showGameUI();
                },
            });
            gisInited = true;
            maybeAttemptSilentSignIn();
        }
        function maybeAttemptSilentSignIn() { if (gapiInited && gisInited) { tokenClient.requestAccessToken({ prompt: '' }); } }
        function handleAuthClick() { if (gapiInited && gisInited) { tokenClient.requestAccessToken({ prompt: 'consent' }); } }
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                authorizeButton.classList.remove('hidden');
                signoutButton.classList.add('hidden');
                freshStartBtn.classList.add('hidden');
                gameContent.classList.add('hidden');
            }
        }
        async function showGameUI() {
            authorizeButton.classList.add('hidden');
            signoutButton.classList.remove('hidden');
            freshStartBtn.classList.remove('hidden');
            gameContent.classList.remove('hidden');
            await loadGameData();
        }
        
        // --- DATA LOADING & RENDERING ---
        async function loadGameData() {
            try {
                await loadProductCatalog();
                await Promise.all([loadCompanyInfo(), loadInventoryData(), loadInTransitData(), loadEventsData()]);
                renderAll();
            } catch (err) { console.error("Fatal error loading game data:", err); alert("A critical error occurred. Please check the console (F12)."); }
        }

        async function loadProductCatalog() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Products!A2:M' });
            products.clear();
            (res.result.values || []).forEach(p => { if (p[0]) { products.set(p[0], { sku: p[0], name: p[1], category: p[2], wholesaleCost: parseFloat(p[6]), retailPrice: parseFloat(p[7]), piecesPerCase: parseInt(p[8]) || 1, sqft: parseInt(p[9]) || 1, salesMultiplier: parseFloat(p[12]) || 1.0 }); } });
        }

        async function loadCompanyInfo() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'My_Company!A2:P2' });
            const data = res.result.values[0] || [];
            companyData = { name: data[0], cash: parseFloat(data[1]) || 0, tier: data[2], date: data[3], businessLoanBalance: parseFloat(data[4]) || 0, realEstateLoanBalance: parseFloat(data[5]) || 0, monthlyOverhead: parseFloat(data[6]) || 0, warehouse1Size: parseInt(data[7]) || 0, warehouse1Multiplier: parseInt(data[8]) || 0, warehouse2Owned: data[9] === 'TRUE', warehouse2Multiplier: parseInt(data[10]) || 0, isOverCapacity: data[11] === 'TRUE', specialOfferSKU: data[12], specialOfferCases: parseInt(data[13]) || 0, specialOfferDiscount: parseFloat(data[14]) || 0, specialOfferPurchased: data[15] === 'TRUE' };
            const currentMonth = new Date(companyData.date).getMonth();
            companyData.demandMultiplier = 0.3;
            if (currentMonth === 5 || currentMonth === 6) { companyData.demandMultiplier = 1.0; } else if (currentMonth === 4 || currentMonth === 7 || currentMonth === 11) { companyData.demandMultiplier = 0.6; }
        }

        async function loadInventoryData() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Inventory!A2:E' });
            inventory.clear();
            let rowNum = 2;
            (res.result.values || []).forEach(row => { if (row[0]) { inventory.set(row[0], { sku: row[0], name: row[1], casesInWarehouse: parseInt(row[2]) || 0, piecesInStore: parseInt(row[3]) || 0, piecesPerCase: parseInt(row[4]) || 0, rowNum: rowNum }); } rowNum++; });
        }

        async function loadInTransitData() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'In-Transit_Orders!B2:C' });
            inTransit.clear();
            (res.result.values || []).forEach(row => { if (row[0]) { const sku = row[0]; const cases = parseInt(row[1]) || 0; inTransit.set(sku, (inTransit.get(sku) || 0) + cases); } });
        }

        async function loadEventsData() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Events!A2:D' });
            events = (res.result.values || []).map(row => ({ name: row[0], startDate: new Date(row[1]), endDate: new Date(row[2]), multiplier: parseFloat(row[3]) || 1 }));
        }

        function renderAll() { updateDashboardUI(); renderOperationsView(); renderCart(); updateSimulateButton(); renderMonthlySpecial(); }

        function updateDashboardUI() {
            const date = new Date(companyData.date);
            const options = { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' };
            document.getElementById('company-name').innerText = companyData.name;
            document.getElementById('company-cash').innerText = `$${companyData.cash.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
            document.getElementById('company-tier').innerText = companyData.tier;
            document.getElementById('game-date').innerText = date.toLocaleDateString('en-US', options);
            const eventBanner = document.getElementById('event-banner');
            const activeEvent = events.find(event => date >= event.startDate && date <= event.endDate);
            if (activeEvent) { eventBanner.innerText = `ðŸŽ‰ EVENT ACTIVE: ${activeEvent.name} (${activeEvent.multiplier}x Sales!)`; eventBanner.classList.remove('hidden'); }
            else { eventBanner.classList.add('hidden'); }
            let totalSqFtUsed = 0, totalInTransitSqFt = 0;
            inventory.forEach(item => totalSqFtUsed += (products.get(item.sku)?.sqft || 0) * item.casesInWarehouse);
            inTransit.forEach((cases, sku) => totalInTransitSqFt += (products.get(sku)?.sqft || 0) * cases);
            const totalEffectiveSpace = companyData.warehouse1Size * companyData.warehouse1Multiplier;
            document.getElementById('company-warehouse').innerText = `${totalSqFtUsed.toLocaleString()} / ${totalEffectiveSpace.toLocaleString()} SqFt`;
            document.getElementById('in-transit-sqft').innerText = `${totalInTransitSqFt.toLocaleString()} SqFt`;
        }

        function renderOperationsView() {
            operationsDisplay.innerHTML = "";
            products.forEach(product => {
                const invItem = inventory.get(product.sku) || { casesInWarehouse: 0, piecesInStore: 0 };
                const transitCases = inTransit.get(product.sku) || 0;
                const row = document.createElement('tr');
                row.innerHTML = `<td>${product.name}</td><td>$${product.wholesaleCost.toFixed(2)}</td><td>${invItem.casesInWarehouse}</td><td>${invItem.piecesInStore}</td><td>${transitCases}</td><td><button class="buy-btn" data-sku="${product.sku}">Buy Case</button><button class="unbox-btn" data-sku="${product.sku}" ${invItem.casesInWarehouse > 0 ? '' : 'disabled'}>Unbox Case</button></td>`;
                operationsDisplay.appendChild(row);
            });
            document.querySelectorAll('.buy-btn').forEach(btn => btn.addEventListener('click', e => updateCartQuantity(e.target.dataset.sku, 1)));
            document.querySelectorAll('.unbox-btn').forEach(btn => btn.addEventListener('click', e => moveCaseToStore(e.target.dataset.sku)));
        }

        function renderCart() {
            cartList.innerHTML = "";
            const { total, discount, subtotal } = calculateTotals();
            if (cart.length === 0) {
                cartList.innerHTML = "<p>Your cart is empty.</p>";
                cartSummary.classList.add('hidden');
                checkoutButton.disabled = true;
                checkoutButton.innerText = 'Place Order';
                return;
            }
            cart.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <div><strong>${item.name}</strong><br>$${(item.wholesaleCost * item.quantity).toFixed(2)}</div>
                    <button class="cart-btn-minus">-</button>
                    <span>${item.quantity}</span>
                    <button class="cart-btn-plus">+</button>
                    <button class="cart-btn-remove">&times;</button>
                `;
                itemDiv.querySelector('.cart-btn-minus').addEventListener('click', () => updateCartQuantity(item.sku, -1));
                itemDiv.querySelector('.cart-btn-plus').addEventListener('click', () => updateCartQuantity(item.sku, 1));
                itemDiv.querySelector('.cart-btn-remove').addEventListener('click', () => removeFromCart(item.sku));
                cartList.appendChild(itemDiv);
            });
            const sqFtOfOrder = cart.reduce((sum, item) => sum + (products.get(item.sku).sqft * item.quantity), 0);
            document.getElementById('summary-sqft').innerText = `${sqFtOfOrder.toLocaleString()} SqFt`;
            document.getElementById('summary-subtotal').innerText = `$${subtotal.toFixed(2)}`;
            document.getElementById('summary-discount').innerText = `-$${discount.toFixed(2)}`;
            document.getElementById('summary-total').innerText = `$${total.toFixed(2)}`;
            cartSummary.classList.remove('hidden');
            if (total > companyData.cash) {
                checkoutButton.disabled = true;
                checkoutButton.innerText = 'Insufficient Funds';
            } else {
                checkoutButton.disabled = false;
                checkoutButton.innerText = 'Place Order';
            }
        }

        function updateSimulateButton() {
            const isOffSeason = (companyData.demandMultiplier || 0.3) < 0.6;
            const isSaturdaysOnly = !sevenDayToggle.checked;
            salesSimBtn.textContent = isSaturdaysOnly && isOffSeason ? "Simulate Week" : "Simulate Day's Sales & Advance Day";
        }
        
        function renderMonthlySpecial() {
            if (!companyData.specialOfferSKU) {
                specialOfferText.innerText = "No special offer this month. Check back on the 1st!";
                buySpecialBtn.classList.add('hidden');
                return;
            }
            const product = products.get(companyData.specialOfferSKU);
            if (!product) {
                specialOfferText.innerText = "Error: Invalid special offer product.";
                buySpecialBtn.classList.add('hidden');
                return;
            }
            if (companyData.specialOfferPurchased) {
                specialOfferText.innerText = `You have already purchased this month's special offer for ${product.name}.`;
                buySpecialBtn.textContent = "Purchased";
                buySpecialBtn.disabled = true;
                buySpecialBtn.classList.remove('hidden');
            } else {
                const totalCost = product.wholesaleCost * companyData.specialOfferCases * (1 - companyData.specialOfferDiscount);
                specialOfferText.innerHTML = `Buy <strong>${companyData.specialOfferCases}</strong> cases of <strong>${product.name}</strong> for <strong>${companyData.specialOfferDiscount * 100}% OFF!</strong><br>Total Cost: $${totalCost.toFixed(2)}`;
                buySpecialBtn.disabled = totalCost > companyData.cash;
                buySpecialBtn.textContent = totalCost > companyData.cash ? "Insufficient Funds" : "Accept Special Offer";
                buySpecialBtn.classList.remove('hidden');
            }
        }

        // --- GAME LOGIC ---
        function addAllToCart() {
            cart = [];
            products.forEach(product => cart.push({ ...product, quantity: 1 }));
            renderCart();
        }
        
        async function unboxAllLowStock() {
            unboxAllBtn.disabled = true;
            const updatesForSheet = []; let unboxedCount = 0;
            for (const item of inventory.values()) {
                if (item.piecesInStore <= 1 && item.casesInWarehouse > 0) {
                    item.casesInWarehouse--; item.piecesInStore += item.piecesPerCase; unboxedCount++;
                    updatesForSheet.push({ range: `Inventory!C${item.rowNum}:D${item.rowNum}`, values: [[item.casesInWarehouse, item.piecesInStore]] });
                }
            }
            if (unboxedCount > 0) {
                try {
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({ spreadsheetId: SPREADSHEET_ID, resource: { valueInputOption: 'USER_ENTERED', data: updatesForSheet } });
                    alert(`Successfully unboxed ${unboxedCount} low-stock case(s).`);
                } catch (err) {
                    console.error("Failed to batch unbox:", err); alert("An error occurred. Please refresh.");
                    await loadGameData();
                }
            } else { alert("No items needed unboxing."); }
            renderAll();
            unboxAllBtn.disabled = false;
        }

        function updateCartQuantity(sku, change) {
            let itemInCart = cart.find(item => item.sku === sku);
            if (itemInCart) {
                itemInCart.quantity += change;
                if (itemInCart.quantity <= 0) removeFromCart(sku);
            } else if (change > 0) {
                const product = products.get(sku);
                if (product) cart.push({ ...product, quantity: 1 });
            }
            renderCart();
        }

        function removeFromCart(sku) {
            cart = cart.filter(item => item.sku !== sku);
            renderCart();
        }
        
        function calculateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.wholesaleCost * item.quantity), 0);
            let discountRate = 0;
            if (subtotal >= 100000) discountRate = 0.50; else if (subtotal >= 50000) discountRate = 0.45; else if (subtotal >= 25000) discountRate = 0.35;
            else if (subtotal >= 10000) discountRate = 0.25; else if (subtotal >= 5000) discountRate = 0.15;
            const discount = subtotal * discountRate;
            return { subtotal, discount, total: subtotal - discount };
        }

        async function moveCaseToStore(sku) {
            const item = inventory.get(sku);
            if (!item || item.casesInWarehouse <= 0) return;
            document.querySelector(`.unbox-btn[data-sku="${sku}"]`).disabled = true;
            item.casesInWarehouse--;
            item.piecesInStore += item.piecesPerCase;
            renderAll();
            try {
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: `Inventory!C${item.rowNum}:D${item.rowNum}`, valueInputOption: "USER_ENTERED", resource: { values: [[item.casesInWarehouse, item.piecesInStore]] } });
            } catch (err) {
                console.error("Failed to update inventory:", err);
                item.casesInWarehouse++;
                item.piecesInStore -= item.piecesPerCase;
                renderAll();
                alert("Error saving changes. Please refresh.");
            }
        }
        
        async function purchaseMonthlySpecial() {
            buySpecialBtn.disabled = true;
            const product = products.get(companyData.specialOfferSKU);
            const totalCost = product.wholesaleCost * companyData.specialOfferCases * (1 - companyData.specialOfferDiscount);
            if(totalCost > companyData.cash) {
                alert("You don't have enough cash to accept this offer.");
                renderMonthlySpecial();
                return;
            }
            const newCash = companyData.cash - totalCost;
            const purchaseId = `PO-SPECIAL-${Date.now()}`;
            const arrivalDate = new Date(companyData.date);
            arrivalDate.setDate(arrivalDate.getDate() + 7);
            const arrivalDateString = arrivalDate.toLocaleDateString();
            const purchaseLogEntry = [`${purchaseId}-${product.sku}`, companyData.date, product.sku, companyData.specialOfferCases, totalCost / companyData.specialOfferCases];
            const inTransitEntry = [purchaseId, product.sku, companyData.specialOfferCases, arrivalDateString];
            try {
                await gapi.client.sheets.spreadsheets.values.batchUpdate({ spreadsheetId: SPREADSHEET_ID, resource: { valueInputOption: 'USER_ENTERED', data: [ { range: 'My_Company!B2', values: [[newCash]] }, { range: 'My_Company!P2', values: [['TRUE']] } ]}});
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'Purchase_Log!A1', valueInputOption: 'USER_ENTERED', resource: { values: [purchaseLogEntry] } });
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'In-Transit_Orders!A1', valueInputOption: 'USER_ENTERED', resource: { values: [inTransitEntry] } });
                alert(`Special offer purchased! Your shipment of ${companyData.specialOfferCases} cases of ${product.name} will arrive on ${arrivalDateString}.`);
            } catch (err) {
                console.error("Error purchasing special offer:", err);
                alert("An error occurred while purchasing the special offer.");
            } finally {
                await loadGameData();
            }
        }

        async function processCheckout() {
            checkoutButton.disabled = true;
            checkoutButton.innerText = 'Processing...';
            try {
                const { total, discount, subtotal } = calculateTotals();
                const discountRate = subtotal > 0 ? discount / subtotal : 0;
                const newCash = companyData.cash - total;
                if (isNaN(newCash)) { alert("Fatal Error: Calculation resulted in an invalid number."); return; }
                const purchaseId = `PO-${Date.now()}`;
                const arrivalDate = new Date(companyData.date);
                arrivalDate.setDate(arrivalDate.getDate() + 7);
                const arrivalDateString = arrivalDate.toLocaleDateString();
                const purchaseLogData = cart.map(item => { const actualPricePaid = item.wholesaleCost * (1 - discountRate); return [`${purchaseId}-${item.sku}`, companyData.date, item.sku, item.quantity, actualPricePaid]; });
                const inTransitData = cart.map(item => [purchaseId, item.sku, item.quantity, arrivalDateString]);
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'My_Company!B2', valueInputOption: 'USER_ENTERED', resource: { values: [[newCash]] } });
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'Purchase_Log!A1', valueInputOption: 'USER_ENTERED', resource: { values: purchaseLogData } });
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'In-Transit_Orders!A1', valueInputOption: 'USER_ENTERED', resource: { values: inTransitData } });
                cart = [];
                await checkBusinessTier();
                alert(`Purchase successful! Your shipment will arrive on ${arrivalDateString}.`);
            } catch (err) {
                console.error("Checkout error:", err);
                alert("An error occurred during checkout.");
            } finally {
                await loadGameData();
            }
        }
        
        async function checkBusinessTier() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Purchase_Log!D2:E' });
                const lifetimeTotal = (response.result.values || []).reduce((sum, row) => sum + ((parseInt(row[0]) || 0) * (parseFloat(row[1]) || 0)), 0);
                let newTier = 'Starter';
                if (lifetimeTotal >= 5000000) newTier = 'Diamond'; else if (lifetimeTotal >= 1500000) newTier = 'Platinum'; else if (lifetimeTotal >= 500000) newTier = 'Gold';
                else if (lifetimeTotal >= 100000) newTier = 'Silver'; else if (lifetimeTotal >= 25000) newTier = 'Bronze';
                if (newTier !== companyData.tier) {
                    await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'My_Company!C2', valueInputOption: 'USER_ENTERED', resource: { values: [[newTier]] } });
                    alert(`Congratulations! You've been promoted to the ${newTier} tier!`);
                }
            } catch (err) { console.error("Error checking business tier:", err); }
        }

        async function checkForArrivingShipments(dateToCheck) {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'In-Transit_Orders!A2:D' });
            const inTransitOrders = res.result.values || [];
            if (inTransitOrders.length === 0) return 0;
            const arrivedShipments = [], stillInTransit = [];
            
            inTransitOrders.forEach(order => { if (order && order[0]) { (new Date(order[3]) <= dateToCheck) ? arrivedShipments.push({ sku: order[1], cases: parseInt(order[2]) }) : stillInTransit.push(order); } });
            
            if (arrivedShipments.length > 0) {
                arrivedShipments.forEach(shipment => {
                    const item = inventory.get(shipment.sku);
                    if (item) { item.casesInWarehouse += shipment.cases; }
                    else {
                        const product = products.get(shipment.sku);
                        const newRowNum = (inventory.size > 0 ? Math.max(...Array.from(inventory.values(), i => i.rowNum)) : 1) + 1;
                        inventory.set(shipment.sku, { sku: shipment.sku, name: product.name, casesInWarehouse: shipment.cases, piecesInStore: 0, piecesPerCase: product.piecesPerCase, rowNum: newRowNum });
                    }
                });
                await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: SPREADSHEET_ID, range: 'In-Transit_Orders!A2:D' });
                if (stillInTransit.length > 0) { await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'In-Transit_Orders!A2', valueInputOption: 'USER_ENTERED', resource: { values: stillInTransit } }); }
                return arrivedShipments.length;
            }
            return 0;
        }
        
        async function startFreshGame() {
            if (!confirm("Are you sure? This will erase all progress.")) return;
            freshStartBtn.disabled = true; freshStartBtn.innerText = 'Resetting...';
            try {
                const startingCart = Array.from(products.values()).map(p => ({ ...p, quantity: 3 }));
                const subtotal = startingCart.reduce((sum, item) => sum + (item.wholesaleCost * item.quantity), 0);
                let discountRate = 0;
                if (subtotal >= 100000) discountRate = 0.50; else if (subtotal >= 50000) discountRate = 0.45; else if (subtotal >= 25000) discountRate = 0.35;
                else if (subtotal >= 10000) discountRate = 0.25; else if (subtotal >= 5000) discountRate = 0.15;
                const totalCost = subtotal * (1 - discountRate);
                const startingDate = '4/1/2025';
                const startingCash = 50000 - totalCost;
                const purchaseId = `PO-START-${Date.now()}`;
                const purchaseLogData = startingCart.map(item => { const actualPricePaid = item.wholesaleCost * (1 - discountRate); return [`${purchaseId}-${item.sku}`, startingDate, item.sku, item.quantity, actualPricePaid]; });
                const inventoryData = startingCart.map(item => [item.sku, item.name, item.quantity, 0, item.piecesPerCase]);
                const myCompanyData = [ 'WhatTheBoom', startingCash, 'Starter', startingDate, 50000, 200000, 3235.23, 600, 2, 'FALSE', 0, 'FALSE' ];
                await gapi.client.sheets.spreadsheets.values.batchClear({ spreadsheetId: SPREADSHEET_ID, resource: { ranges: ['Purchase_Log!A2:E', 'Sales_Log!A2:G', 'Inventory!A2:E', 'In-Transit_Orders!A2:D'] } });
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'My_Company!A2', valueInputOption: 'USER_ENTERED', resource: { values: [myCompanyData] } });
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'Inventory!A2', valueInputOption: 'USER_ENTERED', resource: { values: inventoryData } });
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'Purchase_Log!A1', valueInputOption: 'USER_ENTERED', resource: { values: purchaseLogData } });
                alert('Fresh game started! Your initial inventory is in the warehouse.');
            } catch (err) {
                console.error("Error starting fresh game:", err);
                alert("An error occurred while trying to reset the game.");
            } finally {
                freshStartBtn.disabled = false; freshStartBtn.innerText = 'Start Fresh Game';
                await loadGameData();
            }
        }

      async function simulateSales() {
            salesSimBtn.disabled = true;
            salesSimBtn.textContent = 'Simulating...';
            try {
                const isOffSeason = companyData.demandMultiplier < 0.6;
                const isSaturdaysOnly = !sevenDayToggle.checked;
                const isWeekMode = isSaturdaysOnly && isOffSeason;

                if (isWeekMode) {
                    // --- Full Week Simulation Logic ---
                    let weeklyRevenue = 0, weeklySalesLog = [], arrivedShipmentsCount = 0, weeklyBillsPaid = false;
                    let currentDate = new Date(companyData.date);
                    for (let i = 0; i < 7; i++) {
                        const dayOfWeek = currentDate.getDay(), currentMonth = currentDate.getMonth();
                        const arrivals = await checkForArrivingShipments(currentDate);
                        arrivedShipmentsCount += arrivals;
                        if (dayOfWeek === 6) {
                            for (const item of inventory.values()) {
                                if (item.piecesInStore > 0) {
                                    const product = products.get(item.sku);
                                    if (product && Math.random() < (0.5 * companyData.demandMultiplier * product.salesMultiplier)) {
                                        const piecesSold = Math.min(item.piecesInStore, Math.floor(Math.random() * 5) + 1);
                                        if (piecesSold > 0) {
                                            weeklyRevenue += piecesSold * product.retailPrice;
                                            item.piecesInStore -= piecesSold;
                                            weeklySalesLog.push([`SALE-${Date.now()}-${item.sku}`, currentDate.toLocaleDateString(), item.sku, piecesSold, product.retailPrice]);
                                        }
                                    }
                                }
                            }
                        }
                        const nextDayCheck = new Date(currentDate);
                        nextDayCheck.setDate(nextDayCheck.getDate() + 1);
                        if (nextDayCheck.getMonth() !== currentMonth) { weeklyBillsPaid = true; }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    const finalInventoryData = Array.from(inventory.values()).map(i => [i.sku, i.name, i.casesInWarehouse, i.piecesInStore, i.piecesPerCase]);
                    if (finalInventoryData.length > 0) { await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'Inventory!A2', valueInputOption: 'USER_ENTERED', resource: { values: finalInventoryData } }); }
                    if (weeklySalesLog.length > 0) { await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'Sales_Log!A:E', valueInputOption: 'USER_ENTERED', resource: { values: weeklySalesLog } }); }
                    
                    let finalCash = companyData.cash + weeklyRevenue;
                    const dataForCompanyUpdate = [];
                    let summaryMessage = `Week Advanced!\n- Sales Revenue: $${weeklyRevenue.toFixed(2)}\n- Shipments Arrived: ${arrivedShipmentsCount}`;

                    if (weeklyBillsPaid) {
                        finalCash -= companyData.monthlyOverhead;
                        dataForCompanyUpdate.push({ range: 'My_Company!E2', values: [[companyData.businessLoanBalance - 1062.35]] });
                        dataForCompanyUpdate.push({ range: 'My_Company!F2', values: [[companyData.realEstateLoanBalance - 1672.88]] });
                        summaryMessage += "\n- Monthly bills were paid.";
                        
                        // Generate new monthly special offer
                        const productKeys = Array.from(products.keys());
                        const randomSKU = productKeys[Math.floor(Math.random() * productKeys.length)];
                        const productForOffer = products.get(randomSKU);
                        const casesPerPallet = Math.round((16 / productForOffer.sqft) * 4);
                        const numPallets = Math.random() < 0.7 ? 1 : 2; // 70% chance for 1 pallet, 30% for 2
                        const offerCases = casesPerPallet * numPallets;
                        const offerDiscount = numPallets === 1 ? 0.30 : 0.45; // 30% for 1 pallet, 45% for 2
                        dataForCompanyUpdate.push({ range: 'My_Company!M2:P2', values: [[randomSKU, offerCases, offerDiscount, 'FALSE']] });
                    }
                    
                    dataForCompanyUpdate.push({ range: 'My_Company!B2', values: [[finalCash]] });
                    dataForCompanyUpdate.push({ range: 'My_Company!D2', values: [[currentDate.toLocaleDateString()]] });
                    
                    if (dataForCompanyUpdate.length > 0) { await gapi.client.sheets.spreadsheets.values.batchUpdate({ spreadsheetId: SPREADSHEET_ID, resource: { valueInputOption: 'USER_ENTERED', data: dataForCompanyUpdate } }); }
                    
                    alert(summaryMessage);

                } else {
                    // --- Single Day Simulation Logic ---
                    await checkForArrivingShipments(new Date(companyData.date));
                    await loadGameData();
                    let totalSqFtUsed = 0;
                    inventory.forEach(item => totalSqFtUsed += (products.get(item.sku)?.sqft || 0) * item.casesInWarehouse);
                    const totalEffectiveSpace = companyData.warehouse1Size * companyData.warehouse1Multiplier;
                    if (totalSqFtUsed > totalEffectiveSpace) {
                        if (companyData.isOverCapacity) {
                            let leastValuableItem = null, lowestValuePerSqFt = Infinity;
                            inventory.forEach(item => { if (item.casesInWarehouse > 0) { const product = products.get(item.sku); const valuePerSqFt = product.wholesaleCost / product.sqft; if (valuePerSqFt < lowestValuePerSqFt) { lowestValuePerSqFt = valuePerSqFt; leastValuableItem = item; } } });
                            if (leastValuableItem) {
                                leastValuableItem.casesInWarehouse--;
                                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: `Inventory!C${leastValuableItem.rowNum}`, valueInputOption: 'USER_ENTERED', resource: { values: [[leastValuableItem.casesInWarehouse]] } });
                                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'My_Company!L2', valueInputOption: 'USER_ENTERED', resource: { values: [['FALSE']] } });
                                alert(`Still over capacity! One case of ${leastValuableItem.name} was lost.`);
                            }
                        } else {
                            await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'My_Company!L2', valueInputOption: 'USER_ENTERED', resource: { values: [['TRUE']] } });
                            alert("Warning: Warehouse is over capacity! Unbox cases to make room. If you are still over capacity tomorrow, you will lose inventory.");
                            return;
                        }
                    }
                    if (totalSqFtUsed <= totalEffectiveSpace && companyData.isOverCapacity) { await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'My_Company!L2', valueInputOption: 'USER_ENTERED', resource: { values: [['FALSE']] } }); }
                    
                    let dailyRevenue = 0;
                    const salesLogEntries = [], inventoryToUpdate = new Map();
                    const currentDate = new Date(companyData.date);
                    const isNotSaturday = currentDate.getDay() !== 6;
                    if (!(isSaturdaysOnly && isOffSeason && isNotSaturday)) {
                        for (const item of inventory.values()) {
                            if (item.piecesInStore > 0) {
                                const productInfo = products.get(item.sku);
                                if (productInfo && Math.random() < (0.5 * companyData.demandMultiplier * productInfo.salesMultiplier)) {
                                    const piecesSold = Math.min(item.piecesInStore, Math.floor(Math.random() * 5) + 1);
                                    if (piecesSold > 0) {
                                        dailyRevenue += piecesSold * productInfo.retailPrice;
                                        item.piecesInStore -= piecesSold;
                                        salesLogEntries.push([ `SALE-${Date.now()}-${item.sku}`, companyData.date, item.sku, piecesSold, productInfo.retailPrice ]);
                                        inventoryToUpdate.set(item.sku, { range: `Inventory!D${item.rowNum}`, value: item.piecesInStore });
                                    }
                                }
                            }
                        }
                    }
                    const nextDay = new Date(currentDate); nextDay.setDate(nextDay.getDate() + 1); const nextDateString = nextDay.toLocaleDateString();
                    let finalCash = companyData.cash + dailyRevenue; let billsPaidMessage = ""; const dataForBatchUpdate = [];
                    if (nextDay.getMonth() !== currentDate.getMonth()) {
                        finalCash -= companyData.monthlyOverhead;
                        dataForBatchUpdate.push({ range: 'My_Company!E2', values: [[companyData.businessLoanBalance - 1062.35]] });
                        dataForBatchUpdate.push({ range: 'My_Company!F2', values: [[companyData.realEstateLoanBalance - 1672.88]] });
                        billsPaidMessage = `\nMonthly bills of $${companyData.monthlyOverhead.toFixed(2)} have been paid.`;
                        
                        // Generate new monthly special offer
                        const productKeys = Array.from(products.keys());
                        const randomSKU = productKeys[Math.floor(Math.random() * productKeys.length)];
                        const productForOffer = products.get(randomSKU);
                        const casesPerPallet = Math.round((16 / productForOffer.sqft) * 4);
                        const numPallets = Math.random() < 0.7 ? 1 : 2; // 70% chance for 1 pallet, 30% for 2
                        const offerCases = casesPerPallet * numPallets;
                        const offerDiscount = numPallets === 1 ? 0.30 : 0.45; // 30% for 1 pallet, 45% for 2
                        dataForBatchUpdate.push({ range: 'My_Company!M2:P2', values: [[randomSKU, offerCases, offerDiscount, 'FALSE']] });
                    }
                    inventoryToUpdate.forEach(update => dataForBatchUpdate.push({ range: update.range, values: [[update.value]] }));
                    dataForBatchUpdate.push({ range: 'My_Company!B2', values: [[finalCash]] });
                    dataForBatchUpdate.push({ range: 'My_Company!D2', values: [[nextDateString]] });
                    if (salesLogEntries.length > 0) { await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'Sales_Log!A:E', valueInputOption: 'USER_ENTERED', resource: { values: salesLogEntries } }); }
                    if (dataForBatchUpdate.length > 0) { await gapi.client.sheets.spreadsheets.values.batchUpdate({ spreadsheetId: SPREADSHEET_ID, resource: { valueInputOption: 'USER_ENTERED', data: dataForBatchUpdate } }); }
                    if (salesLogEntries.length > 0) { alert(`Day Advanced! You made ${salesLogEntries.length} sales for $${dailyRevenue.toFixed(2)}.` + billsPaidMessage); }
                    else { alert("A quiet day with no sales. The date has advanced." + billsPaidMessage); }
                }

            } catch (err) {
                console.error("Error during simulation:", err);
                alert("An error occurred during simulation. Please check the console and refresh.");
            } finally {
                salesSimBtn.disabled = false;
                updateSimulateButton();
                await loadGameData();
            }
        }
    </script>
</body>
</html>